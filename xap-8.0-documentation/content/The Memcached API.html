<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
     <head>
         <title>XAP 8.0 Documentation : The Memcached API</title>
<link rel="stylesheet" href="styles/site.css" type="text/css" />
         <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
		 <style>
.back-to {
	color: #666666;
	font-weight: bold;
}	 
a.back-to:link, a.back-to:visited, a.back-to:hover, a.back-to:active  {
	color: #666666;
}	 
		 </style>
     </head>

     <body>
<table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
<tr>
<td valign="top" class="pagebody">
<div class="pageheader">
<span class="back-to">XAP 8.0 Documentation > <a href="index.html">Back to Table of Contents</a></span><br>
<h1>The Memcached API</h1>
</div>
<br>

<script type='text/javascript'>//<![CDATA[
function debug() { }
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/browser.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/behaviour.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/memory.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/cloak.js'>//<![CDATA[
// ]]></script><script type='text/javascript'>//<![CDATA[
Cloak.closeHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_down_10.gif\'/>";
Cloak.openHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_right_10.gif\'/>";
Cloak.toggleZone = true;
Cloak.memoryDuration = 0;
Cloak.memoryPrefix = "contentId:53903741";
Cloak.memoryPath = "/wiki/";
// ]]></script><style type='text/css'>
.cloakToggle { /* Definition for state toggling image */
cursor:hand;
cursor:pointer;
}
</style><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/transitions.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/deck.js'>//<![CDATA[
// ]]></script><link rel='stylesheet' type='text/css'  href='/wiki/styles/main-action.css?pluginCompleteKey=net.customware.confluence.plugin.composition:composition-setup&stylesheetName=deck&spaceKey=XAP8'/><script type='text/javascript'>//<![CDATA[
Deck.memoryDuration = 0;
Deck.memoryPrefix = "contentId:53903741";
Deck.memoryPath = "/wiki/";
// ]]></script>


<div style="border-style:solid; border-color:#3C78B5; border-width:thin; padding-left:20px; padding-bottom:20px; padding-top:20px; padding-right:20px; background-color:#D8E4F1"> 

<p><b>Section Summary:</b>  memcached support on top of the space. </p>
</div>


<h1><a name="TheMemcachedAPI-Overview"></a>Overview</h1>
<p><a href="http://memcached.org/">Memcached</a> is a popular caching protocol and server. The integration provided allows to use GigaSpaces as a memcached server (talking the memcached protocol) enhancing the memcached to provide high availability, write behind, and all the other features that come built in with the space.</p>

<p>The memcached support is provided as a template deployment (similar to how basic data grid deployment works), allowing to easily issue commands to deploy a memcached cluster using the CLI, Admin API, or the UI. See "<a href="The Runtime Environment.html" title="The Runtime Environment">The Runtime Environment</a>" for an explanation of the moving parts and components in a GigaSpaces XAP server instance.</p>

<h1><a name="TheMemcachedAPI-WhyuseMemcachedwithGigaSpacesXAP"></a>Why use Memcached with GigaSpaces XAP</h1>

<p>Memcached is a simple protocol, which makes it naturally cross-platform. This simplicity means a reduction in features, such as failover or distribution of data. The traditional memcached client/server architecture has one memcached client connected to a number of <em>disconnected</em> memcached server instances, which share no data and are entirely unaware of each other.</p>

<p><img src="download/attachments/53903741/traditional_memcached_client.jpg" align="absmiddle" border="0"/></p>

<p>One deployment model for memcached with XAP has one client connecting to multiple access points, each of which is a XAP node that wraps the XAP datagrid access with the memcached protocol:</p>

<p><img src="download/attachments/53903741/oneclient_manyproxies.jpg" align="absmiddle" border="0"/></p>

<p>This model is a drop-in replacement for the traditional memcached deployment, except it adds fault tolerance and distribution to memcached.</p>

<p>The last deployment model uses a single access point for access - a single node compared to the previous model. This model shares locally cached information from the memcached instance, which reduces the infrastructure impact from duplicated cached data.</p>

<p><img src="download/attachments/53903741/xap_memcached_router.jpg" align="absmiddle" border="0"/></p>

<h1><a name="TheMemcachedAPI-Usingmemcached"></a>Using memcached</h1>

<p>Memcached uses a standardized and language-neutral <a href="http://code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt">protocol</a>, providing fourteen commands (six reads, two sets, two updates, one delete, and some status-related commands), issued over a plain text connection. A client application can open a telnet session and use a memcached server with no problems (assuming no errors are made in using the protocol, of course.)</p>

<p>However, since the protocol is simple and well-known, there have been many client libraries written that provide access to memcached services.</p>

<h2><a name="TheMemcachedAPI-UsingmemcachedfromJava"></a>Using memcached from Java</h2>

<p>There are many memcached clients for Java; the one GigaSpaces' example applications have used is <a href="http://code.google.com/p/xmemcached/">xmemcached</a>.</p>

<div class='panelMacro'><table class='warningMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/forbidden.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>If you use Maven, you can include spymemcached as a dependency, by adding a repository reference and a dependency:

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">&lt;dependency&gt;
  &lt;groupId&gt;com.googlecode.xmemcached&lt;/groupId&gt;
  &lt;artifactId&gt;xmemcached&lt;/artifactId&gt;
  &lt;version&gt;1.2.6.2&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div></div></td></tr></table></div>

<p>To connect to a memcached instance, you would first deploy a memcached space in GigaSpaces. For the sake of example, let's assume the memcached instance is deployed on two IPs: 192.168.0.10 (on a server named "memcached1") and 192.168.0.11 ("memcached2").</p>

<p>The code to connect to a server is:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">MemcachedClientBuilder builder = <span class="code-keyword">new</span> XMemcachedClientBuilder(
                        AddrUtil.getAddresses(<span class="code-quote">"memcached1:11211 memcached2:11211"</span>));
MemcachedClient c = builder.build();</pre>
</div></div>

<div class='panelMacro'><table class='warningMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/forbidden.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>Traditional memcached servers shard data by running multiple instances as unassociated peers. Clients connect to each of them, and manually determine which of the server instances data is sent to. 

<p>GigaSpaces' memcached service would run access points on each of the servers - memcached1 and memcached2, as shown above - but the servers share data, so you could get the same dataset by just connecting to only one of the server instances.</p></td></tr></table></div>

<p>Setting data and retrieving it is very simple:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-object">int</span> secondsToLive=60; <span class="code-comment">// 60 seconds
</span>c.set(<span class="code-quote">"key"</span>, secondsToLive, <span class="code-quote">"value"</span>);

<span class="code-object">String</span> value=(<span class="code-object">String</span>)c.get(<span class="code-quote">"key"</span>);

<span class="code-comment">// note that async versions of get exist as well</span></pre>
</div></div>

<h1><a name="TheMemcachedAPI-Deployingmemcached"></a>Deploying memcached</h1>

<p>Deploying memcached requires a single parameter, which is the space to use for the memcached data. The parameter is the space url, and can either be an embedded space, or a remote connection url to an already deployed url. Here are some examples to deploy memcached using the CLI:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"># use the gs-memcached script to start a memcached instance at /./memcached, port 11211
$ gs-memcached.sh

# use the gs-memcached script to start a memcached instance at /./newMemcached
$ gs-memcached.sh /./newMemcached

# deploy a single instance memcached with an embedded space
$ gs.sh deploy-memcached /./mySpace

# deploy a clustered memcached
$ gs.sh deploy-memcached -cluster total_members=2,1 /./mySpace

# deploy a memcached with 5 instances connecting to a remote space
$ gs.sh deploy-memcached -cluster total_members=5 jini:<span class="code-comment">//*/*/mySpace
</span>
# deploy a memcached instance as local cache connecting to a remote space
$ gs.sh deploy-memcached jini:<span class="code-comment">//*/*/mySpace</span></pre>
</div></div>

<p>Deploying using the Admin API is similar:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Admin admin = <span class="code-keyword">new</span> AdminFactory().addGroup(<span class="code-quote">"myGroup"</span>).createAdmin();

admin.getGridServiceManagers().waitFor(1);
admin.getGridServiceContainers().waitFor(2);

ProcessingUnit unit = admin.getGridServiceManagers()
                           .deploy(<span class="code-keyword">new</span> MemcachedDeployment(<span class="code-quote">"/./test"</span>).partitioned(1, 1));
unit.waitFor(unit.getTotalNumberOfInstances());

<span class="code-keyword">for</span> (ProcessingUnitInstance instance : unit) {
    <span class="code-object">System</span>.out.println(instance.getClusterInfo().getUniqueName() + 
              <span class="code-quote">": Memcached started on port ["</span> + instance.getMemcachedDetails().getPort() + <span class="code-quote">"]"</span>);
}

<span class="code-keyword">while</span> (<span class="code-keyword">true</span>) {
    <span class="code-object">Thread</span>.sleep(3000);
    <span class="code-object">System</span>.out.println(<span class="code-quote">"---------------------------------"</span>);
    <span class="code-keyword">for</span> (ProcessingUnitInstance instance : unit) {
        <span class="code-object">System</span>.out.println(instance.getClusterInfo().getUniqueName() + 
             <span class="code-quote">": Gets ["</span> + instance.getStatistics().getMemcached().getGetCmds() + <span class="code-quote">"]"</span>);
    }
}</pre>
</div></div>

<h1><a name="TheMemcachedAPI-memcachedDeploymentDescriptor"></a>memcached Deployment Descriptor</h1>

<p>The memcached deployment descriptor looks as follows, for deployment with a GigaSpaces processing unit:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">&lt;!--
    Spring property configurer which allows us to use system properties (such as user.name).
--&gt;
&lt;bean id=<span class="code-quote">"propertiesConfigurer"</span> 
      class=<span class="code-quote">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>&gt;
    <span class="code-tag">&lt;property name=<span class="code-quote">"properties"</span>&gt;</span>
        <span class="code-tag">&lt;props&gt;</span>
            <span class="code-tag">&lt;prop key=<span class="code-quote">"url"</span>&gt;</span>/./memcached<span class="code-tag">&lt;/prop&gt;</span>
            <span class="code-tag">&lt;prop key=<span class="code-quote">"port"</span>&gt;</span>11211<span class="code-tag">&lt;/prop&gt;</span>
            <span class="code-tag">&lt;prop key=<span class="code-quote">"portRetries"</span>&gt;</span>10<span class="code-tag">&lt;/prop&gt;</span>
            <span class="code-tag">&lt;prop key=<span class="code-quote">"threaded"</span>&gt;</span>true<span class="code-tag">&lt;/prop&gt;</span>
        <span class="code-tag">&lt;/props&gt;</span>
    <span class="code-tag">&lt;/property&gt;</span>
<span class="code-tag">&lt;/bean&gt;</span>

&lt;!--
    A bean representing an embedded space (an IJSpace implementation).
--&gt;
<span class="code-tag">&lt;os-core:space id=<span class="code-quote">"space"</span> url=<span class="code-quote">"${url}"</span> versioned=<span class="code-quote">"true"</span>&gt;</span>
<span class="code-tag">&lt;/os-core:space&gt;</span>

<span class="code-tag">&lt;os-core:local-cache id=<span class="code-quote">"localCache"</span> space=<span class="code-quote">"space"</span>&gt;</span>
    
<span class="code-tag">&lt;/os-core:local-cache&gt;</span>

<span class="code-tag">&lt;os-core:giga-space id=<span class="code-quote">"gigaSpace"</span> space=<span class="code-quote">"localCache"</span> /&gt;</span>

<span class="code-tag">&lt;bean id=<span class="code-quote">"memcached"</span> class=<span class="code-quote">"org.openspaces.memcached.MemCacheDaemon"</span>&gt;</span>
    <span class="code-tag">&lt;property name=<span class="code-quote">"space"</span> ref=<span class="code-quote">"gigaSpace"</span> /&gt;</span>
    <span class="code-tag">&lt;property name=<span class="code-quote">"port"</span> value=<span class="code-quote">"${port}"</span>/&gt;</span>
    <span class="code-tag">&lt;property name=<span class="code-quote">"portRetries"</span> value=<span class="code-quote">"${portRetries}"</span> /&gt;</span>
    <span class="code-tag">&lt;property name=<span class="code-quote">"threaded"</span> value=<span class="code-quote">"${threaded}"</span> /&gt;</span>
<span class="code-tag">&lt;/bean&gt;</span></pre>
</div></div>

<p>The deployment defined a space, with the provided deployment url (so it can be embedded or remote). It defines a local cache on top of the space, and that local cache is passed to the <tt>MemCacheDaemon</tt>.</p>

<p>The <tt>MemCacheDaemon</tt> start listening on the provided port, and if that port is busy, the next port will be used. The daemon accepts different memcached protocol commands, and translates them into operations on the space.</p>

<h3><a name="TheMemcachedAPI-LocalCache"></a>Local Cache</h3>

<p>A local cache is started by default on each instance, and works against the whole cluster. Since memcached clients have no concept of routing and how routing is done by the space, a request can hit a certain instance, and be routed to a different space instance. The idea of the local cache is to improve the performance of "get" requests.</p>

<p>Most memcached clients allow to provide a list of memcached servers to connect to. Another improvement that most of them provides us the ability to have consistent hashing of keys to the same server instance. This can result in both high hit rate on the local cache, and less eviction happening.</p>

<h1><a name="TheMemcachedAPI-Performance"></a>Performance</h1>
<p>The results below compares native memcached with GigaSpaces memcached:<br/>
<img src="download/attachments/48235229/native_memcachedvsGigaSpaces_memcached.jpg" align="absmiddle" border="0"/></p>

<p>The command used to generate the results is:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">memslap --concurrency=$i --test=get --servers=$SERVER:$PORT</pre>
</div></div>

<h2><a name="TheMemcachedAPI-TestSetup"></a>Test Setup</h2>
<ul class="alternate" type="square">
	<li>Client: CentOS 5 , 4 x AMD Opteron Dual-core 8220 2.8Ghz , Sun Fire X4600</li>
	<li>memcached Server:CentOS 5 , Intel(R) Xeon(R) CPU X5570  @ 2.93GHz , CISCO USC</li>
	<li>Space Configuration: one instance. No backup. Deploy command:
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">gs.sh deploy-memcached /./mySpace</pre>
</div></div></li>
</ul>


                     </td>
</tr>
</table>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td height="12" background="http://www.gigaspaces.com/wiki/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
</tr>
<tr>
<td align="center"><font color="grey"><a href="http://www.gigaspaces.com">GigaSpaces.com</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xwBmAg" class="smalltext">Legal Notice</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xgBmAg" class="smalltext">3rd Party Licenses</a> -
		<a href="http://www.gigaspaces.com/wiki/x/BQFmAg" class="smalltext">Site Map</a> -
		<a href="http://www.gigaspaces.com/wiki/display/API/API+Documentation+Portal" class="version-link">API Docs</a> -
		<a href="http://forum.openspaces.org/forum.jspa?forumID=175" class="version-link">Forum</a> -
		<a href="http://www.gigaspaces.com/LatestProductVersion" class="version-link">Downloads</a> -
		<a href="http://blog.gigaspaces.com/" class="version-link">Blog</a> -
		<a href="http://www.gigaspaces.com/os_papers.html" class="version-link">White Papers</a> -
		<a href="mailto:techw@gigaspaces.com">Contact Tech Writing</a> -
		<i><a href="http://www.atlassian.com/software/confluence">Gen. by Atlassian Confluence</a></i></font></td>
</tr>
</table>
     </body>
</html>
