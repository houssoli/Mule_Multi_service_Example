<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
     <head>
         <title>XAP 8.0 Documentation : Space Instance Recovery</title>
<link rel="stylesheet" href="styles/site.css" type="text/css" />
         <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
		 <style>
.back-to {
	color: #666666;
	font-weight: bold;
}	 
a.back-to:link, a.back-to:visited, a.back-to:hover, a.back-to:active  {
	color: #666666;
}	 
		 </style>
     </head>

     <body>
<table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
<tr>
<td valign="top" class="pagebody">
<div class="pageheader">
<span class="back-to">XAP 8.0 Documentation > <a href="index.html">Back to Table of Contents</a></span><br>
<h1>Space Instance Recovery</h1>
</div>
<br>

<script type='text/javascript'>//<![CDATA[
function debug() { }
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/browser.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/behaviour.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/memory.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/cloak.js'>//<![CDATA[
// ]]></script><script type='text/javascript'>//<![CDATA[
Cloak.closeHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_down_10.gif\'/>";
Cloak.openHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_right_10.gif\'/>";
Cloak.toggleZone = true;
Cloak.memoryDuration = 0;
Cloak.memoryPrefix = "contentId:55443754";
Cloak.memoryPath = "/wiki/";
// ]]></script><style type='text/css'>
.cloakToggle { /* Definition for state toggling image */
cursor:hand;
cursor:pointer;
}
</style><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/transitions.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/deck.js'>//<![CDATA[
// ]]></script><link rel='stylesheet' type='text/css'  href='/wiki/styles/main-action.css?pluginCompleteKey=net.customware.confluence.plugin.composition:composition-setup&stylesheetName=deck&spaceKey=XAP8'/><script type='text/javascript'>//<![CDATA[
Deck.memoryDuration = 0;
Deck.memoryPrefix = "contentId:55443754";
Deck.memoryPath = "/wiki/";
// ]]></script>

<div style="border-style:solid; border-color:#3C78B5; border-width:thin; padding-left:20px; padding-bottom:20px; padding-top:20px; padding-right:20px; background-color:#D8E4F1"> 

<p><b>Section Summary:</b>  How space instance recovers its data when first started, relocated or after an unexpected failure. </p>
</div>

<h1><a name="SpaceInstanceRecovery-Overview"></a>Overview</h1>

<p>Recovery is a process that happens on space instance startup or relocation and used to synchronize the space instance data with another space instance in its replication group. </p>

<p>When space instance is the first to start and doesn't have another space instance to recover from - it's data is loaded from the External Data Source if such was defined, otherwise the space will start empty.</p>

<h1><a name="SpaceInstanceRecovery-Terminology"></a>Terminology</h1>

<ul>
	<li>Target space instance - the space instance that recovers the data from another space instance.</li>
	<li>Source space instance - the space instance that the data is recovered from.</li>
	<li>Recovery data - Recovery involves two types of data to recover:
	<ul>
		<li>Space objects</li>
		<li>Notify registrations</li>
	</ul>
	</li>
</ul>


<h1><a name="SpaceInstanceRecovery-Recoveryprocess"></a>Recovery process</h1>

<p>Recovery process has two phases: a snapshot phase and a completion phase. </p>

<h2><a name="SpaceInstanceRecovery-SnapshotPhase"></a>Snapshot Phase</h2>

<p>All space objects are copied from to the target to the source in batches. This is done concurrently by multiple threads. <br/>
In case the recovery process takes a lot of time, the following configuration can be tuned to decrease the recovery time.</p>

<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> Property </th>
<th class='confluenceTh'> Description </th>
<th class='confluenceTh'> Default Value </th>
</tr>
<tr>
<td class='confluenceTd'> <tt>cluster-config.groups.group.repl-policy.recovery-chunk-size</tt> </td>
<td class='confluenceTd'> Integer value. Defines how many operations are recovered is a single batch  </td>
<td class='confluenceTd'> 200 </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>cluster-config.groups.group.repl-policy.recovery-thread-pool-size</tt> </td>
<td class='confluenceTd'> Integer value. Defines how many threads are recovering the data during the snapshot process . </td>
<td class='confluenceTd'> 4 </td>
</tr>
</tbody></table>

<h2><a name="SpaceInstanceRecovery-CompletionPhase"></a>Completion Phase </h2>

<p>Operations that were performed on the source space during the snapshot phase are not a part of the recovered snapshot, so they are accumulated in the source space instance redo-log and are sent to the target space once the snapshot phase is finished via replication. <br/>
In case a limited redo log is used the following property defines the maximum size of the redo log during recovery:</p>

<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> Property </th>
<th class='confluenceTh'> Description </th>
<th class='confluenceTh'> Default Value </th>
</tr>
<tr>
<td class='confluenceTd'> <tt>cluster-config.groups.group.repl-policy.redo-log-recovery-capacity</tt> </td>
<td class='confluenceTd'> Integer value. Defines the maximum size of the redo log kept on the source space during recovery.  </td>
<td class='confluenceTd'> 5000000 </td>
</tr>
</tbody></table>

<p><img src="download/attachments/19890517/referto.gif" align="absmiddle" border="0"/> For more info refer to <a href="Controlling the Replication Redo Log.html" title="Controlling the Replication Redo Log">Controlling the Replication Redo Log</a></p>

<p>Completion phase is finished according to the consistency requirements of the replication type.</p>
<p><img src="download/attachments/19890517/referto.gif" align="absmiddle" border="0"/> For more info refer to <a href="Synchronous Replication.html#SynchronousReplication-BehaviorDuringRecovery">Synchronous Replication Behavior During Recovery</a> and <a href="Asynchronous Replication.html#AsynchronousReplication-BehaviorDuringRecovery">Asynchronous Replication Behavior During Recovery</a></p>

<p>Once the recovery process is complete, a full report including the total amount of recovered space objects and notify registrations, and their class types, is logged. <br/>
During the recovery process, the source space is available, and the target space is unavailable to clients.</p>

<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>

<ul>
	<li>Replication input filter events are called during recovery (on the target).</li>
	<li>Space filter events are not called during recovery.</li>
	<li>The space instance locates a space to recover from using the Jini Lookup Service - each replication group has a unique name.<br/>
 The source space looks for a matching space with the same replication group to recover from.</li>
	<li>Partial recovery - the restarted space recovers only classes with the <tt>@SpaceClass (replicate=true)</tt> decoration (turned on only when partial replication is enabled).</li>
</ul>

</td></tr></table></div>


<h1><a name="SpaceInstanceRecovery-PrimaryBackupTopology"></a>Primary-Backup Topology</h1>

<p>In primary-backup topologies the recovering space instance is always a backup, primary space instances don't recover their data from other spaces.<br/>
The recovering backup space instance connects to its primary space instance and recovers its data only from it. <br/>
If there are other space instances in the same replication group, they don't replicate their data to the recovered space instance.</p>


<h2><a name="SpaceInstanceRecovery-PrimaryBackupPersistentTopology"></a>Primary-Backup Persistent Topology</h2>

<p>Primary and Backup space instances use the same database to stored their data. The space is the system of record. The data is usually persisted through the Mirror service.<br/>
Which data is recovered depends on the space caching policy.<br/>
There is special handling for <a href="Transient Entries.html" title="Transient Entries">Transient Entries</a> (<tt>persist=false</tt>), since they can't be persisted - they are always recovered from the primary.</p>

<h3><a name="SpaceInstanceRecovery-AllInCachePolicy"></a>All In Cache Policy</h3>

<p>A backup instance recovers <b>all its data</b> from the primary instance - data is not loaded from the database. This is done so that any data changes on the primary during the recovery process are consistent on the backup once recovery finishes.</p>

<h3><a name="SpaceInstanceRecovery-LRUCachePolicy"></a>LRU Cache Policy</h3>

<p>A backup instance recovers <b>only transient</b> entries from the primary instance. Data is not loaded from the database. </p>
<div class="indent20 inline" style="margin-left: 20px;"><style type="text/css">div.inline p:first-child { display: inline; }</style><p><img src="download/attachments/48235229/data-grid-sync-persist.jpg" align="absmiddle" border="0"/></p></div>
<p>Since primary and backup use the same database instance, the data will be loaded to the backup on demand.</p>

<h2><a name="SpaceInstanceRecovery-BackupInstanceRecoveryFailureHandling"></a>Backup Instance Recovery Failure Handling</h2>

<p>If a backup space instance recovery process fails, it is handled in the following way:<br/>
If the primary space is unavailable for some reason - recovery will be retried  until one of the following happens:</p>
<ul class="alternate" type="square">
	<li>the primary gets reconnected and then the recovery continues normally.</li>
	<li>the space itself becomes primary and then no recovery is necessary.</li>
</ul>


<p>Any other failure - <a href="ALL IN CACHE-Cache Policy.html#ALLINCACHE-CachePolicy-SpaceMemoryShortageException">SpaceMemoryShortageException</a>, Database not available etc. is retried 3 times before failing.</p>

<h1><a name="SpaceInstanceRecovery-ActiveActiveTopology"></a>Active-Active Topology</h1>

<p>In active-active topologies the recovering space instance connects to one of the space instances in its replication group and recovers all the data from it.<br/>
If there are other space instances in the same replication group, after recovery other they connect the recovered space instance and replicate their data as well.</p>

<h2><a name="SpaceInstanceRecovery-ActiveActivePersistentTopology"></a>Active-Active Persistent Topology</h2>

<p>Replicated space instances  keep and manage their data in a separate databases. </p>
<div class="indent20 inline" style="margin-left: 20px;"><style type="text/css">div.inline p:first-child { display: inline; }</style><p><img src="download/attachments/48235229/data-grid-sync-persist_non_central_db.jpg" align="absmiddle" border="0"/></p></div>
<p>With this scenario:</p>
<ol>
	<li>If the database is empty --&gt; target space instance recovers everything from the source.</li>
	<li>If database has data --&gt; recover persistent objects from the database + recover transient objects from the source.</li>
</ol>


<p>For further info and configuration options see <a href="Direct Persistency.html#DirectPersistency-DistributedDatabases">Distributed Databases</a></p>

<h2><a name="SpaceInstanceRecovery-SpaceInstanceRecoveryFailureHandling"></a>Space Instance Recovery Failure Handling</h2>

<p>If the recovery process fails, it is retried 3 times before failing.</p>




                     </td>
</tr>
</table>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td height="12" background="http://www.gigaspaces.com/wiki/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
</tr>
<tr>
<td align="center"><font color="grey"><a href="http://www.gigaspaces.com">GigaSpaces.com</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xwBmAg" class="smalltext">Legal Notice</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xgBmAg" class="smalltext">3rd Party Licenses</a> -
		<a href="http://www.gigaspaces.com/wiki/x/BQFmAg" class="smalltext">Site Map</a> -
		<a href="http://www.gigaspaces.com/wiki/display/API/API+Documentation+Portal" class="version-link">API Docs</a> -
		<a href="http://forum.openspaces.org/forum.jspa?forumID=175" class="version-link">Forum</a> -
		<a href="http://www.gigaspaces.com/LatestProductVersion" class="version-link">Downloads</a> -
		<a href="http://blog.gigaspaces.com/" class="version-link">Blog</a> -
		<a href="http://www.gigaspaces.com/os_papers.html" class="version-link">White Papers</a> -
		<a href="mailto:techw@gigaspaces.com">Contact Tech Writing</a> -
		<i><a href="http://www.atlassian.com/software/confluence">Gen. by Atlassian Confluence</a></i></font></td>
</tr>
</table>
     </body>
</html>
