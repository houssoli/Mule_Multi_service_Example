<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
     <head>
         <title>XAP 8.0 Documentation : GigaSpaces CPP Processing Unit Example</title>
<link rel="stylesheet" href="styles/site.css" type="text/css" />
         <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
		 <style>
.back-to {
	color: #666666;
	font-weight: bold;
}	 
a.back-to:link, a.back-to:visited, a.back-to:hover, a.back-to:active  {
	color: #666666;
}	 
		 </style>
     </head>

     <body>
<table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
<tr>
<td valign="top" class="pagebody">
<div class="pageheader">
<span class="back-to">XAP 8.0 Documentation > <a href="index.html">Back to Table of Contents</a></span><br>
<h1>GigaSpaces CPP Processing Unit Example</h1>
</div>
<br>

<script type='text/javascript'>//<![CDATA[
function debug() { }
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/browser.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/behaviour.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/memory.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/cloak.js'>//<![CDATA[
// ]]></script><script type='text/javascript'>//<![CDATA[
Cloak.closeHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_down_10.gif\'/>";
Cloak.openHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_right_10.gif\'/>";
Cloak.toggleZone = true;
Cloak.memoryDuration = 0;
Cloak.memoryPrefix = "contentId:53903386";
Cloak.memoryPath = "/wiki/";
// ]]></script><style type='text/css'>
.cloakToggle { /* Definition for state toggling image */
cursor:hand;
cursor:pointer;
}
</style><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/transitions.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/deck.js'>//<![CDATA[
// ]]></script><link rel='stylesheet' type='text/css'  href='/wiki/styles/main-action.css?pluginCompleteKey=net.customware.confluence.plugin.composition:composition-setup&stylesheetName=deck&spaceKey=XAP8'/><script type='text/javascript'>//<![CDATA[
Deck.memoryDuration = 0;
Deck.memoryPrefix = "contentId:53903386";
Deck.memoryPath = "/wiki/";
// ]]></script>
<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td> <b>Summary:</b> Example application that demonstrates the concept of Processing Unit.<hr 
 size="1" 
 color="#003366" 
 >
<div class="error"><span class="error">Error formatting macro: toc: java.lang.NullPointerException</span> </div></td></tr></table></div>

<h1><a name="GigaSpacesCPPProcessingUnitExample-Overview"></a>Overview</h1>

<p>The Processing Unit example is located at <tt>&lt;GigaSpaces Root&gt;\cpp\examples\CppService</tt> and <tt>&lt;GigaSpaces Root&gt;\cpp\examples\CppServiceOpenSpaces</tt>.<br/>
If you use <b>Visual Studio</b> open the solution <tt>examples.sln</tt> located in <tt>&lt;GigaSpaces Root&gt;\cpp\examples</tt>. It is recommended to set your solution configuration to <tt>Release</tt> and do a rebuild that will generate all related files.</p>

<h1><a name="GigaSpacesCPPProcessingUnitExample-C%5CProcessingUnitImplementation"></a>C+&#43; Processing Unit Implementation</h1>

<h2><a name="GigaSpacesCPPProcessingUnitExample-ImplementingCppWorker"></a>Implementing CppWorker</h2>

<p>To create your own <tt>CppWorker</tt> you should inherit your class from <tt>ICppWorker</tt> and implement the following methods:</p>
<ul>
	<li><tt>run()</tt> &#8211; the logic that the processing unit should perform.</li>
	<li><tt>destroy()</tt> &#8211; put your cleaning and thread termination here.</li>
</ul>


<p>The rest of the interface is for deploying the service and we just need to change the name of the service to our new name.</p>

<p><span id='tgl_content_1' class='cloakToggle'></span>  <sub><b>Click Here to view the example code (the full source code can be found at <tt>&lt;GigaSpaces Root&gt;\cpp\examples\CppService\CppService.cpp</tt>)</b></sub></p>


<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">#include &lt;windows.h&gt;
#endif


class CppService : <span class="code-keyword">public</span> ICppWorker
{
<span class="code-keyword">public</span>:
	CppService():  m_callback(0),m_isRunning(<span class="code-keyword">true</span>){}
	virtual ~CppService() {}
	virtual <span class="code-keyword">const</span> <span class="code-object">char</span>* className() { <span class="code-keyword">return</span> <span class="code-quote">"CppService"</span>; }
	virtual bool  Initialize(IWorkerPeer* Host);
	virtual CommandObjectPtr run(CommandObjectPtr);
	virtual bool  Destroy();

<span class="code-keyword">private</span>:
	IWorkerPeer*	m_callback;
	bool			m_isRunning;
};

bool CppService::Initialize(IWorkerPeer* Host)
{
	m_callback = Host;
	<span class="code-keyword">return</span> <span class="code-keyword">true</span>;	
}

CommandObjectPtr CppService::run(CommandObjectPtr <span class="code-object">Object</span>)
{

	genericVector	replyParams = <span class="code-object">Object</span>-&gt;getParameters();
	SpaceProxyPtr	proxy;
	SpaceFinder		finder;
    
	std::cout&lt;&lt;  <span class="code-quote">"----The C++ service CppService STARTED -----"</span> &lt;&lt; std::endl;
	
	<span class="code-object">long</span> <span class="code-object">long</span> proxyId = any_cast&lt;<span class="code-object">long</span> <span class="code-object">long</span>&gt;(replyParams[0]);

	std::cout&lt;&lt;  <span class="code-quote">"----The ID: "</span> &lt;&lt; proxyId &lt;&lt; std::endl;
	<span class="code-keyword">try</span>
	{
		proxy = finder.attach( proxyId, <span class="code-keyword">false</span>);
		std::cout&lt;&lt;  <span class="code-quote">"----Find Proxy ------ "</span> &lt;&lt; std::endl;
	}
	<span class="code-keyword">catch</span>(FinderException&amp; )
	{
		std::cout &lt;&lt; <span class="code-quote">"Caught FinderException"</span> &lt;&lt; std::endl;
	}
	<span class="code-keyword">catch</span>(XAPException &amp;)
	{
		std::cout &lt;&lt; <span class="code-quote">"Caught <span class="code-keyword">generic</span> XAP Exception"</span> &lt;&lt; std::endl;
	}

	/************************************************************/
    /*                                                          */
    /*  At <span class="code-keyword">this</span> point CPP is alive and running and one may      */
    /*  use any of the proxy API in order to interact with      */
    /*  the space and perform calculations or general           */
    /*  business logic.                                         */
    /*                                                          */
	/************************************************************/
	
	<span class="code-keyword">try</span>
	{
		Message messageTemplate;
		proxy-&gt;snapshot(&amp;messageTemplate);
	    
		std::cout&lt;&lt;  <span class="code-quote">"-- Snapshot Done"</span> &lt;&lt; std::endl;
		<span class="code-keyword">while</span>(m_isRunning)
		{

			std::cout &lt;&lt; <span class="code-quote">"*****Worker Running***** "</span> &lt;&lt; std::endl;
			MessagePtr msg( <span class="code-keyword">new</span> Message() );
			
			msg-&gt;content = <span class="code-quote">"Hello World"</span>;
			msg-&gt;id = 1;	<span class="code-comment">// Fill index
</span>			std::cout&lt;&lt;  <span class="code-quote">"-- Before Write Message Done"</span> &lt;&lt; std::endl;
			proxy-&gt;write(msg.get(), NULL_TX, Lease::FOREVER); 
			std::cout&lt;&lt;  <span class="code-quote">"-- Write Message Done"</span> &lt;&lt; std::endl;

			MessagePtr result ( proxy-&gt;read(&amp;messageTemplate, NULL_TX, 0) );
			std::cout&lt;&lt;  <span class="code-quote">"-- Read Message Done"</span> &lt;&lt; std::endl;

			proxy-&gt;take(&amp;messageTemplate, NULL_TX, 0);
			std::cout&lt;&lt;  <span class="code-quote">"-- Take Message Done"</span> &lt;&lt; std::endl;
	        
			ACE_OS::sleep(1);
		}
	} 
	<span class="code-keyword">catch</span>(XAPException &amp;e)
	{
		e.toLogger();
	}

	genericVector	params;
	CommandObjectPtr ptr( <span class="code-keyword">new</span> CommandObject(<span class="code-quote">"Results"</span>,params));
	<span class="code-keyword">return</span> ptr;
}

/****************************************************************/
/* Called upon Destruction of the Space                         */
/****************************************************************/

bool CppService::Destroy()
{
	m_isRunning = <span class="code-keyword">false</span>;
	std::cout&lt;&lt;  <span class="code-quote">"---- Destroy  -----"</span> &lt;&lt; std::endl;
	<span class="code-keyword">return</span> <span class="code-keyword">true</span>;
}

#<span class="code-keyword">if</span> defined(_WIN32)
#define EXPORT __declspec(dllexport)
#<span class="code-keyword">else</span>
#define EXPORT
#endif

extern <span class="code-quote">"C"</span> EXPORT ICppWorker* getWorkerByClass(<span class="code-keyword">const</span> <span class="code-object">char</span>* className)
{
	std::cout&lt;&lt;  <span class="code-quote">"---- className: "</span> &lt;&lt; className &lt;&lt; std::endl;
	<span class="code-keyword">return</span> (0 == strcmp(className, <span class="code-quote">"CppService"</span>)) ? <span class="code-keyword">new</span> CppService : 0;
}</pre>
</div></div>



<h2><a name="GigaSpacesCPPProcessingUnitExample-ProcessingUnitConfigurationFile"></a>Processing Unit Configuration File</h2>
<p>The CPP PU following the standard <a href="The Processing Unit Structure and Configuration.html" title="The Processing Unit Structure and Configuration">Processing Unit Configuration</a>.<br/>
<span id='tgl_content_2' class='cloakToggle'></span>  <sub><b>Click Here to view the CPP PU Configuration File</b></sub></p>



<p>The Processing Unit configuration file (<tt>&lt;GigaSpaces Root&gt;\cpp\examples\CppServiceOpenSpaces\src\META-INF\spring\pu.xml</tt>) includes the following:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml"><span class="code-tag">&lt;?xml version=<span class="code-quote">"1.0"</span> encoding=<span class="code-quote">"UTF-8"</span>?&gt;</span>
&lt;beans xmlns=<span class="code-quote">"http://www.springframework.org/schema/beans"</span>
       <span class="code-keyword">xmlns:xsi</span>=<span class="code-quote">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="code-keyword">xmlns:os-core</span>=<span class="code-quote">"http://www.openspaces.org/schema/core"</span>
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.openspaces.org/schema/core http://www.openspaces.org/schema/core/openspaces-core.xsd"&gt;

    &lt;!--
        Spring property configurer which allows us to use system properties (such as user.name).
    --&gt;
    <span class="code-tag">&lt;bean id=<span class="code-quote">"propertiesConfigurer"</span> class=<span class="code-quote">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>/&gt;</span>

    &lt;!--
        A bean representing a space (an IJSpace implementation).
    --&gt;
    <span class="code-tag">&lt;os-core:space id=<span class="code-quote">"space"</span> url=<span class="code-quote">"/./space"</span> /&gt;</span>

    &lt;!--
        OpenSpaces simplified space API built on top of IJSpace/JavaSpace.
    --&gt;
    <span class="code-tag">&lt;os-core:giga-space id=<span class="code-quote">"gigaSpace"</span> space=<span class="code-quote">"space"</span> /&gt;</span>

	&lt;!--
	The cpp worker example.
	For creating cpp worker we always use the CXXBean.
	We define the cpp worker we want to run by setting the workerName property.
	--&gt;
    <span class="code-tag">&lt;bean id=<span class="code-quote">"cpp"</span> class=<span class="code-quote">"com.gigaspaces.javacpp.openspaces.CXXBean"</span>&gt;</span>
        <span class="code-tag">&lt;property name=<span class="code-quote">"gigaSpace"</span> ref=<span class="code-quote">"gigaSpace"</span> /&gt;</span>
		<span class="code-tag">&lt;property name=<span class="code-quote">"workerName"</span> value=<span class="code-quote">"CppService"</span> /&gt;</span>
    <span class="code-tag">&lt;/bean&gt;</span>
<span class="code-tag">&lt;/beans&gt;</span></pre>
</div></div>



<h1><a name="GigaSpacesCPPProcessingUnitExample-BuildingandRunningtheExample"></a>Building and Running the Example</h1>

<ul class="alternate" type="square">
	<li>To open the example use the <tt>example.sln</tt> located in <tt>&lt;GigaSpaces Root&gt;\cpp\examples</tt>.</li>
	<li>Select the <em>Release</em> configuration and rebuild the solution.</li>
	<li>Run:
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">&lt;GigaSpaces Root&gt;\bin\gs-agent.bat/sh</pre>
</div></div></li>
</ul>


<p>The build and configuration files are located in <tt>&lt;GigaSpaces Root&gt;\cpp\examples\CppServiceOpenSpaces</tt> folder. <br/>
To deploy the processing unit , move to the above folder and run the following:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">build deploy-local-cppexample</pre>
</div></div>
<p>The following output will be displayed:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">D:\gigaspaces-xap-premium-7.1.0-ga\cpp\examples\CppServiceOpenSpaces&gt;build.bat deploy-local-cppexample
Buildfile: build.xml

build:

dist:

copy-local-cppexample:
   [delete] Deleting directory D:\gigaspaces-xap-premium-7.1.0-ga\deploy\cppexample
    [mkdir] Created dir: D:\gigaspaces-xap-premium-7.1.0-ga\deploy\cppexample
     [copy] Copying 1 file to D:\gigaspaces-xap-premium-7.1.0-ga\deploy\cppexample

deploy-local-cppexample:
     [java] Log file: D:\gigaspaces-xap-premium-7.1.0-ga\lib\logs\2010-04-29~18.19-gigaspaces-service-192.168.1.102-3560.log
     [java] Apr 29, 2010 6:19:35 PM org.openspaces.pu.container.servicegrid.deploy.Deploy info
     [java] INFO: Deploying [cppexample] with name [cppexample] under groups [gigaspaces-7.1.0-XAPPremium-ga] and locators <span class="code-keyword">null</span>
     [java] Apr 29, 2010 6:19:35 PM org.openspaces.pu.container.servicegrid.deploy.Deploy info
     [java] INFO: Searching <span class="code-keyword">for</span> GSM in groups [gigaspaces-7.1.0-XAPPremium-ga] and locators [<span class="code-keyword">null</span>]
     [java] Apr 29, 2010 6:19:41 PM org.springframework.beans.factory.xml.XmlBeanDefinitionReader loadBeanDefinitions
     [java] INFO: Loading XML bean definitions from resource loaded from <span class="code-object">byte</span> array
     [java] Apr 29, 2010 6:19:53 PM org.openspaces.pu.container.servicegrid.deploy.Deploy info
     [java] INFO: SLA Not Found in PU.  Using Default SLA.
     [java] Apr 29, 2010 6:19:54 PM org.openspaces.pu.container.servicegrid.deploy.Deploy info
     [java] INFO: Waiting <span class="code-keyword">for</span> [1] processing unit instances to be deployed...
     [java] Apr 29, 2010 6:19:58 PM org.openspaces.pu.container.servicegrid.deploy.Deploy info
     [java] INFO: [cppexample] [1] deployed successfully on [192.168.1.102]
     [java] Apr 29, 2010 6:19:58 PM org.openspaces.pu.container.servicegrid.deploy.Deploy info
     [java] INFO: Finished deploying [1] processing unit instances

BUILD SUCCESSFUL
Total time: 26 seconds</pre>
</div></div>
<p>The gs-agnet console will have the following output:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">[gsc][5/5352]   ----Find Proxy ------
[gsc][5/5352]   -- Snapshot Done
[gsc][5/5352]   *****Worker Running*****
[gsc][5/5352]   -- Before Write Message Done
[gsc][5/5352]   -- Write Message Done
[gsc][5/5352]   -- Read Message Done
[gsc][5/5352]   -- Take Message Done
[gsc][5/5352]   *****Worker Running*****
[gsc][5/5352]   -- Before Write Message Done
[gsc][5/5352]   -- Write Message Done
[gsc][5/5352]   -- Read Message Done
[gsc][5/5352]   -- Take Message Done</pre>
</div></div>

<p>To view the deployed CPP PU start the GS-UI:</p>
<ol>
	<li>Run &lt;GigaSpaces Root&gt;\bin\gs-ui.bat/sh</li>
</ol>


<p><img src="download/attachments/48235236/cpp_pu.jpg" align="absmiddle" border="0"/></p>

<p>To view the space deployed as part of the CPP PU move into the Deployed Processing Unit Tab:<br/>
<img src="download/attachments/48235236/cpp_pu2.jpg" align="absmiddle" border="0"/></p>

<p>To undeploy the CPP PU:<br/>
<img src="download/attachments/48235236/cpp_pu3.jpg" align="absmiddle" border="0"/></p>

<p>To deploy a clustered CPP PU, Click the <b>Deploy Application</b> button and have the following:<br/>
<img src="download/attachments/48235236/cpp_pu6.jpg" align="absmiddle" border="0"/></p>

<p>This will deploy the CPP PU with 2 partitions and a backup for each partition.</p>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>After deploying and un-deploying the CPP PU, you will have to terminate the existing GSC and start a new fresh GSC to deploy the CPP PU again.<br/>
<img src="download/attachments/48235236/cpp_pu4.jpg" align="absmiddle" border="0"/><br/>
<img src="download/attachments/48235236/cpp_pu5.jpg" align="absmiddle" border="0"/></td></tr></table></div>


                     </td>
</tr>
</table>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td height="12" background="http://www.gigaspaces.com/wiki/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
</tr>
<tr>
<td align="center"><font color="grey"><a href="http://www.gigaspaces.com">GigaSpaces.com</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xwBmAg" class="smalltext">Legal Notice</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xgBmAg" class="smalltext">3rd Party Licenses</a> -
		<a href="http://www.gigaspaces.com/wiki/x/BQFmAg" class="smalltext">Site Map</a> -
		<a href="http://www.gigaspaces.com/wiki/display/API/API+Documentation+Portal" class="version-link">API Docs</a> -
		<a href="http://forum.openspaces.org/forum.jspa?forumID=175" class="version-link">Forum</a> -
		<a href="http://www.gigaspaces.com/LatestProductVersion" class="version-link">Downloads</a> -
		<a href="http://blog.gigaspaces.com/" class="version-link">Blog</a> -
		<a href="http://www.gigaspaces.com/os_papers.html" class="version-link">White Papers</a> -
		<a href="mailto:techw@gigaspaces.com">Contact Tech Writing</a> -
		<i><a href="http://www.atlassian.com/software/confluence">Gen. by Atlassian Confluence</a></i></font></td>
</tr>
</table>
     </body>
</html>
