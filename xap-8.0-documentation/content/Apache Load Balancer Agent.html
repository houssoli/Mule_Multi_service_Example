<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
     <head>
         <title>XAP 8.0 Documentation : Apache Load Balancer Agent</title>
<link rel="stylesheet" href="styles/site.css" type="text/css" />
         <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
		 <style>
.back-to {
	color: #666666;
	font-weight: bold;
}	 
a.back-to:link, a.back-to:visited, a.back-to:hover, a.back-to:active  {
	color: #666666;
}	 
		 </style>
     </head>

     <body>
<table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
<tr>
<td valign="top" class="pagebody">
<div class="pageheader">
<span class="back-to">XAP 8.0 Documentation > <a href="index.html">Back to Table of Contents</a></span><br>
<h1>Apache Load Balancer Agent</h1>
</div>
<br>

<script type='text/javascript'>//<![CDATA[
function debug() { }
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/browser.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/behaviour.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/memory.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/cloak.js'>//<![CDATA[
// ]]></script><script type='text/javascript'>//<![CDATA[
Cloak.closeHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_down_10.gif\'/>";
Cloak.openHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_right_10.gif\'/>";
Cloak.toggleZone = true;
Cloak.memoryDuration = 0;
Cloak.memoryPrefix = "contentId:53903805";
Cloak.memoryPath = "/wiki/";
// ]]></script><style type='text/css'>
.cloakToggle { /* Definition for state toggling image */
cursor:hand;
cursor:pointer;
}
</style><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/transitions.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/deck.js'>//<![CDATA[
// ]]></script><link rel='stylesheet' type='text/css'  href='/wiki/styles/main-action.css?pluginCompleteKey=net.customware.confluence.plugin.composition:composition-setup&stylesheetName=deck&spaceKey=XAP8'/><script type='text/javascript'>//<![CDATA[
Deck.memoryDuration = 0;
Deck.memoryPrefix = "contentId:53903805";
Deck.memoryPath = "/wiki/";
// ]]></script>


<div style="border-style:solid; border-color:#3C78B5; border-width:thin; padding-left:20px; padding-bottom:20px; padding-top:20px; padding-right:20px; background-color:#D8E4F1"> 

<p><b>Section Summary:</b>  Provides dynamic load balancing integration with an Apache httpd server. </p>
</div>


<h1><a name="ApacheLoadBalancerAgent-Overview"></a>Overview</h1>

<p>GigaSpaces comes with a built-in utility allowing you to dynamically update an Apache httpd web server load-balancing configuration, based on deployed web applications.</p>

<p>The integration dynamically creates and updates the  <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy_balancer.html">mod_proxy_balancer</a> configuration, based on the state of the deployed web applications. Once changes occur (relocation / failover / changes to the number of web application instances), the utility identifies the change, updates the balancer configuration, and sends a soft restart to Apache to take the new configuration into account.</p>

<p>General information on how to enable the mod_proxy load balancer and configuration can be found in the <a href="http://docs.codehaus.org/display/JETTY/Configuring+mod_proxy">Jetty mod_proxy docs</a>. Note, the load balancer actual configuration of specific balancer members are generated automatically as explained below.</p>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>Similar agents can be implemented for other HTTP load-balancers such as <a href="http://www.f5.com">F5</a>, <a href="http://www.radware.com">Radware</a>, <a href="http://www.cisco.com/en/US/products/ps6906">CISCO ACE</a>, <a href="http://www.barracudanetworks.com">Barracuda</a> etc., using the <a href="Administration and Monitoring API.html" title="Administration and Monitoring API">Administration and Monitoring API</a>. See the <a href="http://www.gigaspaces.com/wiki/display/SBP/Web+Load+Balancer+Agent+PU" title="Web Load Balancer Agent PU">Web Load Balancer Agent PU</a> for details. </td></tr></table></div>

<h1><a name="ApacheLoadBalancerAgent-HowitWorks%3F"></a>How it Works?</h1>
<p>Here is a description of the flow that eventually scales the web application dynamically:<br/>
<img src="download/attachments/48235229/httpd_lb_agent.jpg" align="absmiddle" border="0"/></p>
<ol>
	<li>Monitoring Service getting statistics about the behavior of the web application. It could statistics for a specific web application instance or multiple ones.</li>
	<li>The Monitoring Service identifies that some SLA has been breached. It waits some time to make sure it is not a sudden behavior that should be ignored. If the value monitored still breach it threshold, The Monitor Service calling the relevant API to scale the web application by adding web application instances or removing existing web application instances.</li>
	<li>The GSM receives the command and tries to deploy additional instance(s) of the web application. Based on the SLA the GSM will provision new web application instances to GSC that already hosting web application instances or to an empty ones. It can also start new GSCs via the GSA. If there are no available GSCs, a provisioning failure event will be thrown.</li>
	<li>Once a new instance of the web application has been fully deployed and started the Apache HTTPD Load-Balancer Agent will be notified. It will reconfigure the HTTPD Load-Balancer mapping to have the location of the new web application added and will perform soft re-start of the Apache HTTPD Load-Balancer to accept the new configuration.</li>
	<li>New HTTP requests will be routed (based on the HTTPD load-balancing policy) into the new web application to serve the users requests.</li>
</ol>


<h1><a name="ApacheLoadBalancerAgent-Usage"></a>Usage</h1>

<p>The agent resides within <tt>GigaSpaces Root folder/tools/apache</tt> and includes the <tt>apache-lb-agent</tt> script. The script should run within the same box where the Apache server is running.</p>

<p>The agent uses two main configurations. The first is the directory where the load-balancer configuration files are created (there is one per web application). The second is the command the script executes in order to update Apache with the changes made to the load-balancer configuration files.</p>

<p>By default, the script assumes that Apache is installed under <tt>PROGRAM_FILES/Apache Software Foundation/Apache2.2</tt> for <br/>
Windows, and <tt>/opt/local/apache2</tt> for Unix. The location of Apache can be controlled using the <tt>-apache</tt> command line parameter. Here is an example for executing the script with a custom Apache location:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">apache-lb-agent.sh -apache /opt/apache</pre>
</div></div>

<p>When using just the Apache location, the configuration files are created under [apache]/conf/gigaspaces. The command executed is <tt>[apache]/bin/apachectl graceful</tt> on Unix, and <tt>[apache]\bin\httpd.exe -k restart</tt> on Windows.</p>

<p>The specific location of the configuration directory where the load-balancer configuration files are created, can be passed using the <tt>-conf-dir</tt> command line parameter. For example:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">apache-lb-agent.sh -apache /opt/apache -conf-dir /<span class="code-keyword">var</span>/apache/conf/gigaspaces</pre>
</div></div>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>The Apache configuration should be updated to include the load-balancer configuration directory, the relevant modules required and optionally to enable the load-balancer console. Here is an example of the configuration sections that should be added to Apache:

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Include /opt/local/apache2/conf/gigaspaces/*.conf 

LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule status_module modules/mod_status.so

ProxyPass /balancer !
&lt;Location /balancer&gt;
SetHandler balancer-manager
&lt;/Location&gt;</pre>
</div></div></td></tr></table></div>

<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'>Command Line parameter</th>
<th class='confluenceTh'>Description</th>
<th class='confluenceTh'>Default Value</th>
</tr>
<tr>
<td class='confluenceTd'>-apache <tt>location</tt></td>
<td class='confluenceTd'>The installation location of apache (<tt>apache root folder</tt>).</td>
<td class='confluenceTd'>windows/unix common locations</td>
</tr>
<tr>
<td class='confluenceTd'>-conf-dir <tt>location</tt></td>
<td class='confluenceTd'>The directory where the <a href="#ApacheLoadBalancerAgent-LoadBalancerConfiguration">load balancer config</a> files will be created. </td>
<td class='confluenceTd'><tt>apache root folder</tt>/conf/gigaspaces</td>
</tr>
<tr>
<td class='confluenceTd'>-update-interval <tt>value</tt></td>
<td class='confluenceTd'>The update interval command. The interval (in milliseconds) when the load balancer conf files will be updated). The agent updates the configuration files and sends the restart command periodically. All changes happening to the deployment are accumulated and then flushed. </td>
<td class='confluenceTd'> 10000 (10 seconds)</td>
</tr>
<tr>
<td class='confluenceTd'>-restart-command <tt>value</tt></td>
<td class='confluenceTd'>The full apache restart command.</td>
<td class='confluenceTd'> windows: httpd -k restart <br clear="all" />unix: apachectl graceful</td>
</tr>
<tr>
<td class='confluenceTd'>-apachectl <tt>location</tt></td>
<td class='confluenceTd'>Controls the The <tt>apachectl</tt>/<tt>httpd</tt> executable name and full path location. This overrides the <tt>-apache</tt> parameter. If this argument is not specified the agent looking for the apachectl(on unix) or httpd.exe(on windows) executable under <tt>apache root folder/bin/</tt> folder.</td>
<td class='confluenceTd'>&nbsp;</td>
</tr>
<tr>
<td class='confluenceTd'>-groups <tt>value</tt></td>
<td class='confluenceTd'>Lookup group name (or coma separated group names) to locate the lookup service via multicast discovery protocol. This option is relevant only when the load-balanacer machine has multicast connectivity with the GSM machine.</td>
<td class='confluenceTd'>The GigaSpaces default group name specified via the <tt>LOOKUPGROUPS</tt> variable.</td>
</tr>
<tr>
<td class='confluenceTd'>-locators <tt>value</tt></td>
<td class='confluenceTd'>Host machine name(or coma separated host names) or IP(s) running the lookup service.</td>
<td class='confluenceTd'> The GigaSpaces default locators specified via the <tt>LOOKUPLOCATORS</tt> variable.</td>
</tr>
</tbody></table>

<p>The agent listens for changes happening in the web application deployment topology running within the Service Grid. If custom lookup groups or lookup locators are used, the agent scripts use the built-in options within the product to change them (for example, in setenv.(bat/sh)). </p>

<h1><a name="ApacheLoadBalancerAgent-LoadBalancerConfiguration"></a>Load Balancer Configuration</h1>

<p>A load-balancer configuration is created for each web application deployed into the service grid. The template used to generate the load-balancer configuration can be found under <tt>GigaSpaces Root folder/tools/apache/balancer-template.vm</tt>. The file is a velocity template, used to generate the actual load-balancer configuration. It is passed with an instance of the <tt>org.openspaces.pu.container.jee.lb.apache.LoadBalancerInfo</tt> object, which holds all the information regarding the currently deployed web application instances locations.</p>

<p>Processing unit specific templates can be created by placing a <b>processing unit name.vm</b> file in the same location. Note, the processing unit name is the name of the processing unit which defaults to the war file name, but can be overridden using the <tt>override-name</tt> option.</p>

                     </td>
</tr>
</table>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td height="12" background="http://www.gigaspaces.com/wiki/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
</tr>
<tr>
<td align="center"><font color="grey"><a href="http://www.gigaspaces.com">GigaSpaces.com</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xwBmAg" class="smalltext">Legal Notice</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xgBmAg" class="smalltext">3rd Party Licenses</a> -
		<a href="http://www.gigaspaces.com/wiki/x/BQFmAg" class="smalltext">Site Map</a> -
		<a href="http://www.gigaspaces.com/wiki/display/API/API+Documentation+Portal" class="version-link">API Docs</a> -
		<a href="http://forum.openspaces.org/forum.jspa?forumID=175" class="version-link">Forum</a> -
		<a href="http://www.gigaspaces.com/LatestProductVersion" class="version-link">Downloads</a> -
		<a href="http://blog.gigaspaces.com/" class="version-link">Blog</a> -
		<a href="http://www.gigaspaces.com/os_papers.html" class="version-link">White Papers</a> -
		<a href="mailto:techw@gigaspaces.com">Contact Tech Writing</a> -
		<i><a href="http://www.atlassian.com/software/confluence">Gen. by Atlassian Confluence</a></i></font></td>
</tr>
</table>
     </body>
</html>
