<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
     <head>
         <title>XAP 8.0 Documentation : Memory Management Facilities</title>
<link rel="stylesheet" href="styles/site.css" type="text/css" />
         <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
		 <style>
.back-to {
	color: #666666;
	font-weight: bold;
}	 
a.back-to:link, a.back-to:visited, a.back-to:hover, a.back-to:active  {
	color: #666666;
}	 
		 </style>
     </head>

     <body>
<table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
<tr>
<td valign="top" class="pagebody">
<div class="pageheader">
<span class="back-to">XAP 8.0 Documentation > <a href="index.html">Back to Table of Contents</a></span><br>
<h1>Memory Management Facilities</h1>
</div>
<br>



<div style="border-style:solid; border-color:#3C78B5; border-width:thin; padding-left:20px; padding-bottom:20px; padding-top:20px; padding-right:20px; background-color:#D8E4F1"> 

<p><b>Section Summary:</b>  Setting Space cache policy, memory usage, and rules for exceeding physical memory capacity. </p>
</div>

<h1><a name="MemoryManagementFacilities-Overview"></a>Overview</h1>
<p>The Memory Management facility is used to assist the client in avoiding a situation where a space server gets into an out-of-memory failure scenario. Based on the configured cache policy, the memory manager protects the space (and the application, in the case it is running collocated with the space) from consuming memory beyond a defined threshold.</p>

<div class='panelMacro'><table class='warningMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/forbidden.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>The client/Application is expected to have some business logic that will handle  <tt>org.openspaces.core.SpaceMemoryShortageException</tt> that might be thrown (when using the openspaces API). When the legacy <tt>IJSpace</tt> interface is used, <tt>com.j_spaces.core.MemoryShortageException</tt> will be thrown instead. Without such a business logic, the space server or a client local cache may eventually exhaust all their parent process available memory resources.</td></tr></table></div>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>Most of the considerations described in this topic are also relevant for the client application when running a Local Cache that is running in LRU Cache policy.</td></tr></table></div>

<p>The space memory can be managed using the following:</p>
<ul>
	<li>Eviction policy - You can set the policy to run <tt>ALL IN CACHE</tt> or <tt>LRU</tt> (Least Recently Used).</li>
	<li>Memory Manager - Provides options for controlling the JVM that is hosting the space memory utilization. It allows you to define thresholds for situations where the memory becomes over-utilized.</li>
</ul>


<h1><a name="MemoryManagementFacilities-CacheEvictionPolicies"></a>Cache Eviction Policies</h1>
<p>The space supports two cache eviction policies: <a href="LRU-Cache Policy.html" title="LRU-Cache Policy">LRU&#45;Cache Policy</a> (code 0) and <a href="ALL IN CACHE-Cache Policy.html" title="ALL IN CACHE-Cache Policy">ALL IN CACHE&#45;Cache Policy</a> (code 1) defined via the the <tt>space-config.engine.cache_policy</tt> property. See below example how you can configure it:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">&lt;os-core:space id=<span class="code-quote">"space"</span> url=<span class="code-quote">"/./space"</span>&gt;
    &lt;os-core:properties&gt;
        &lt;props&gt;
            &lt;prop key=<span class="code-quote">"space-config.engine.cache_policy"</span>&gt;0&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/os-core:properties&gt;
&lt;/os-core:space&gt;</pre>
</div></div>

<ul class="alternate" type="square">
	<li><a href="ALL IN CACHE-Cache Policy.html" title="ALL IN CACHE-Cache Policy">ALL IN CACHE&#45;Cache Policy</a> - Assuming the JVM hosting the space instance has enough heap to hold all data in memory.</li>
	<li><a href="LRU-Cache Policy.html" title="LRU-Cache Policy">LRU&#45;Cache Policy</a> - Assuming the JVM hosting the space instance does not have enough heap to hold all data in memory.</li>
</ul>


<h1><a name="MemoryManagementFacilities-CalculatingtheAvailableMemory"></a>Calculating the Available Memory</h1>
<p>Both the <tt>ALL_IN_CACHE</tt> and <tt>LRU</tt> cache policies calculating the JVM process available memory to determine if there is a need to throw <tt>SpaceMemoryShortageException</tt> or to start and evict objects. Calculating the available memory is performed when the following operations are called:<br/>
abort, changeReplicationState, clear, commit, count, getReplicationStatus, getRuntimeInfo, getSpacePump, getTemplatesInfo, joinReplicationGroup, leaveReplicationGroup, notify, prepare, prepareAndCommit, execute, read, readMultiple, replace, spaceCopy, update, updateMultiple, write.</p>

<p>Before throwing <tt>SpaceMemoryShortageException</tt> or <tt>MemoryShortageException</tt> the local cache/local view/space performs an explicit garbage collection call (system.gc), allowing the JVM to reclaim any unused heap memory. This activity may happen at the client side when running a local cache or a local view or at the space side (JVM hosting the GSC).</p>

<p>The explicit garbage collection call reduces the probability throwing <tt>SpaceMemoryShortageException</tt> or <tt>MemoryShortageException</tt> in case the JVM does have some available memory left. Still, such a call might impact the client side (when running local cache/view) or space side responsiveness since during the garbage collection activity no JVM thread will manage to perform its activity. With a client or space using large heap size this might introduce a long pause.</p>

<p>To avoid such a behavior you should add one of the following into your client or space side JVM parameters list:<br/>
-XX:+DisableExplicitGC<br/>
-XX:+ExplicitGCInvokesConcurrent</p>

<h1><a name="MemoryManagementFacilities-HandlingLargeJVMHeapSize"></a>Handling Large JVM Heap Size</h1>
<p>When configuring the JVM to use large heap size (over 10GB) it is recommended to use the following values:</p>
<ul class="alternate" type="square">
	<li><tt>space-config.engine.memory_usage.high_watermark_percentage</tt> - 99</li>
	<li><tt>space-config.engine.memory_usage.write_only_block_percentage</tt> - 98</li>
	<li><tt>space-config.engine.memory_usage.write_only_check_percentage</tt> - 97</li>
	<li><tt>space-config.engine.memory_usage.low_watermark_percentage</tt> - 95</li>
</ul>


<p>These values represent 400MB difference between the <tt>high_watermark_percentage</tt> and the <tt>low_watermark_percentage</tt> when having 10GB max heap size. The above values will make sure the memory manager will not waste memory, but throw <tt>MemoryShortageException</tt> when running in <tt>ALL_IN_CACHE</tt> or evict objects when running in <tt>LRU</tt> cache policy mode when the absolute amount of JVM available memory is low.</p>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>With large JVM heap size it is recommended to use the CMS Garbage collector. This will avoid long Garbage collector pauses.</td></tr></table></div>

<h1><a name="MemoryManagementFacilities-MemoryManagerActivitywhenInitializingtheSpace"></a>Memory Manager Activity when Initializing the Space</h1>
<p>In this phase of the space life cycle, the space checks for the amount of available memory. This is relevant when the space performs a warm start, such as <tt>ExternalDataSource.initialLoad()</tt>, or in a persistent space using SA with RDBMS or an embedded H2 database.            </p>

<h1><a name="MemoryManagementFacilities-MemoryManagerandTransientObjects"></a>Memory Manager and Transient Objects</h1>
<p>Transient Objects are specified using the <tt>@SpaceClass (persist=false)</tt> decoration. You may specify transient decoration at the class or object level (field method level decoration).<br/>
When using transient objects, note that they are:</p>
<ul class="alternate" type="square">
	<li>Included in the free heap size calculation.</li>
	<li>Included in the count of total objects (for max cache size).</li>
	<li>Not evicted when running in LRU cache policy mode.</li>
</ul>


<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>You may use the transient object option to prevent the space from evicting objects you are not interested to be removed from the space when running in LRU cache policy mode. </td></tr></table></div>

<h1><a name="MemoryManagementFacilities-MemoryManagerParameters"></a>Memory Manager Parameters</h1>
<p>The following properties used to control the memory manager.</p>
<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> Property </th>
<th class='confluenceTh'> Description </th>
<th class='confluenceTh'> Default value </th>
<th class='confluenceTh'> Supported with Cache Policy </th>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.cache_size</tt> </td>
<td class='confluenceTd'> Defines the maximum size of the space cache. This is the total number of space objects across all space class instances, within a single space. This parameter is ignored when running an <tt>ALL_IN_CACHE</tt> cache policy.</td>
<td class='confluenceTd'> <tt>100,000</tt> </td>
<td class='confluenceTd'> LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.high_watermark_percentage</tt> </td>
<td class='confluenceTd'> Specifies a maximum threshold for memory use. If the space container's memory usage exceeds this threshold, a <tt>com.j_spaces.core.MemoryShortageException</tt> is thrown. </td>
<td class='confluenceTd'> <tt>95</tt> </td>
<td class='confluenceTd'> ALL_IN_CACHE, LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.low_watermark_percentage</tt> </td>
<td class='confluenceTd'> Specifies the recommended lower threshold for the JVM heap size that should be occupied by the space container. When the system reaches the <tt>high_watermark_percentage</tt>, it evicts objects on an LRU basis, and attempts to reach this <tt>low_watermark_percentage</tt>. This process continues until there are no more objects to be evicted, or until memory use reaches the <tt>low_watermark_percentage</tt>. </td>
<td class='confluenceTd'> <tt>75</tt> </td>
<td class='confluenceTd'> LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.eviction_batch_size</tt> </td>
<td class='confluenceTd'> Specifies the amount of objects to evict each time. This option is relevant only in LRU cache management policy. </td>
<td class='confluenceTd'> <tt>500</tt> </td>
<td class='confluenceTd'>LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.write_only_block_percentage</tt> </td>
<td class='confluenceTd'> Specifies a lower threshold for blocking <tt>write-type</tt> operations. Above this level, only read/take operations are allowed. </td>
<td class='confluenceTd'> <tt>85</tt> </td>
<td class='confluenceTd'>ALL_IN_CACHE,LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.write_only_check_percentage</tt> </td>
<td class='confluenceTd'> Specifies an upper threshold for checking only <tt>write-type</tt> operations. Above this level, all operations are checked. </td>
<td class='confluenceTd'> <tt>76</tt> </td>
<td class='confluenceTd'>ALL_IN_CACHE </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.retry_count</tt> </td>
<td class='confluenceTd'> Number of retries to lower the memory level below the <tt>Low_watermark_percentage</tt>. If after all retries, the memory level is still above the <tt>space-config.engine.memory_usage.write_only_block_percentage</tt>, a <tt>com.j_spaces.core.MemoryShortageException</tt> is thrown for that write request. </td>
<td class='confluenceTd'> <tt>5</tt> </td>
<td class='confluenceTd'>LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.explicit-gc</tt> </td>
<td class='confluenceTd'> If <tt>true</tt>, the garbage collector is called explicitly before trying to evict. <br clear="all" /> <br clear="all" />
<img class="emoticon" src="images/icons/emoticons/warning.gif" height="16" width="16" align="absmiddle" alt="" border="0"/> When using the LRU cache policy, <tt>space-config.engine.memory_usage.explicit-gc=false</tt> means that the garbage collector might evict less objects than the defined minimum (low watermark percentage). This tag is <tt>false</tt> by default, because setting the garbage collector explicitly consumes a large amount of CPU, thus affecting performance. Therefore, it is recommended that you define <tt>true</tt>, only if you want to ensure that the minimum amount of objects are evicted from the space (and not less than the minimum). </td>
<td class='confluenceTd'> <tt>false</tt> </td>
<td class='confluenceTd'>LRU </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>space-config.engine.memory_usage.retry_yield_time</tt></td>
<td class='confluenceTd'> Time (in milliseconds) to wait after evicting a batch of objects, and before measuring the current memory utilization. </td>
<td class='confluenceTd'> 50 </td>
<td class='confluenceTd'>LRU </td>
</tr>
<tr>
<td class='confluenceTd'><tt>space-config.engine.initial_load</tt></td>
<td class='confluenceTd'>a persistent space running in LRU cache policy mode is started/deployed, it loads data from the underlying data source before being available for clients to access. The default behavior is to load data up to 50% of the space-config.engine.cache_size value. See the <a href="LRU-Cache Policy.html#LRU-CachePolicy-ReloadingData">Reloading Data</a> section for details.</td>
<td class='confluenceTd'> 50 </td>
<td class='confluenceTd'> LRU </td>
</tr>
</tbody></table>

<p><img class="emoticon" src="images/icons/emoticons/information.gif" height="16" width="16" align="absmiddle" alt="" border="0"/> A <tt>com.j_spaces.core.MemoryShortageException</tt> or an <tt>org.openspaces.core.SpaceMemoryShortageException</tt> are thrown only when the JVM garbage collection and the eviction mechanism do not evict enough memory. This can happen if the <tt>space-config.engine.memory_usage.low_watermark_percentage</tt> value is too high.</p>

<h1><a name="MemoryManagementFacilities-ExceedingPhysicalMemoryCapacity"></a>Exceeding Physical Memory Capacity</h1>
<p>The overall space capacity is not necessarily limited to the capacity of its physical memory. Currently there are two options for exceeding this limit:</p>
<ul>
	<li><b>Using an LRU and <a href="External Data Source.html" title="External Data Source">External Data Source</a></b> - in this mode, all the space data is kept in the database and therefore the space capacity is dependent on the database capacity rather than the memory capacity. The space maintains in memory, a partial image of the persistent view in an LRU basis.</li>
	<li><b>Using <a href="Terminology - Data Grid Topologies.html" title="Terminology - Data Grid Topologies">Partitioned Space</a></b> - in this mode, the space utilizes the physical memory of multiple JVMs. This means the application using the space is able to access all the space instances transparently, as if they were a single space with higher memory capacity.</li>
</ul>


<script type='text/javascript'>//<![CDATA[
function debug() { }
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/browser.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/behaviour.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/memory.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/cloak.js'>//<![CDATA[
// ]]></script><script type='text/javascript'>//<![CDATA[
Cloak.closeHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_down_10.gif\'/>";
Cloak.openHTML = "<img src=\'/wiki/download/resources/net.customware.confluence.plugin.composition:toggle-cloak/img/navigate_right_10.gif\'/>";
Cloak.toggleZone = true;
Cloak.memoryDuration = 0;
Cloak.memoryPrefix = "contentId:53903610";
Cloak.memoryPath = "/wiki/";
// ]]></script><style type='text/css'>
.cloakToggle { /* Definition for state toggling image */
cursor:hand;
cursor:pointer;
}
</style><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/transitions.js'>//<![CDATA[
// ]]></script><script type='text/javascript' src='/wiki/download/resources/net.customware.confluence.plugin.composition:composition-setup/js/deck.js'>//<![CDATA[
// ]]></script><link rel='stylesheet' type='text/css'  href='/wiki/styles/main-action.css?pluginCompleteKey=net.customware.confluence.plugin.composition:composition-setup&stylesheetName=deck&spaceKey=XAP8'/><script type='text/javascript'>//<![CDATA[
Deck.memoryDuration = 0;
Deck.memoryPrefix = "contentId:53903610";
Deck.memoryPath = "/wiki/";
// ]]></script>
<h1><a name="MemoryManagementFacilities-SectionContents"></a>Section Contents</h1>
<ul><li><a href="ALL IN CACHE-Cache Policy.html" title="ALL IN CACHE-Cache Policy">ALL IN CACHE-Cache Policy</a> &mdash; <span class="smalltext">The ALL-In-Cache Cache policy</span></li><li><a href="LRU-Cache Policy.html" title="LRU-Cache Policy">LRU-Cache Policy</a> &mdash; <span class="smalltext">The LRU Cache policy</span></li></ul>

                     </td>
</tr>
</table>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td height="12" background="http://www.gigaspaces.com/wiki/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
</tr>
<tr>
<td align="center"><font color="grey"><a href="http://www.gigaspaces.com">GigaSpaces.com</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xwBmAg" class="smalltext">Legal Notice</a> -
		<a href="http://www.gigaspaces.com/wiki/x/xgBmAg" class="smalltext">3rd Party Licenses</a> -
		<a href="http://www.gigaspaces.com/wiki/x/BQFmAg" class="smalltext">Site Map</a> -
		<a href="http://www.gigaspaces.com/wiki/display/API/API+Documentation+Portal" class="version-link">API Docs</a> -
		<a href="http://forum.openspaces.org/forum.jspa?forumID=175" class="version-link">Forum</a> -
		<a href="http://www.gigaspaces.com/LatestProductVersion" class="version-link">Downloads</a> -
		<a href="http://blog.gigaspaces.com/" class="version-link">Blog</a> -
		<a href="http://www.gigaspaces.com/os_papers.html" class="version-link">White Papers</a> -
		<a href="mailto:techw@gigaspaces.com">Contact Tech Writing</a> -
		<i><a href="http://www.atlassian.com/software/confluence">Gen. by Atlassian Confluence</a></i></font></td>
</tr>
</table>
     </body>
</html>
